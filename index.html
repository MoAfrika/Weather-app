<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Weather Shaman: Ultima</title>
    
    <!-- Fonts: Outfit (Premium, Clean, Mystical) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Tailwind CSS (Must load BEFORE config to define the 'tailwind' object) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        obsidian: 'rgba(0, 0, 0, 0.2)',
                        obsidianHigh: 'rgba(0, 0, 0, 0.4)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'mesh': 'mesh 20s ease infinite alternate',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        mesh: {
                            '0%': { backgroundPosition: '0% 0%' },
                            '100%': { backgroundPosition: '100% 100%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL & UTILITIES --- */
        body {
            background-color: #000;
            color: #ffffff;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "cv11", "ss01";
        }

        /* --- PREMIUM MESH GRADIENTS (Apple Weather Style) --- */
        
        .bg-mesh-base {
            background-size: 200% 200%;
            transition: background-image 1.5s ease-in-out;
        }

        /* Clear: Deep Azure, Cyan, Golden Hour */
        .theme-clear { 
            background-image: radial-gradient(at 0% 0%, #0ea5e9 0px, transparent 50%), 
                              radial-gradient(at 100% 0%, #3b82f6 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, #6366f1 0px, transparent 50%), 
                              radial-gradient(at 0% 100%, #06b6d4 0px, transparent 50%),
                              linear-gradient(to bottom, #0f172a, #1e3a8a);
        }

        /* Cloudy: Slate, Silver, Lavender */
        .theme-cloudy { 
            background-image: radial-gradient(at 50% 0%, #94a3b8 0px, transparent 50%), 
                              radial-gradient(at 100% 0%, #64748b 0px, transparent 50%), 
                              radial-gradient(at 0% 100%, #475569 0px, transparent 50%),
                              linear-gradient(to bottom, #1e293b, #334155);
        }

        /* Rain: Midnight Indigo, Electric Blue */
        .theme-rain { 
            background-image: radial-gradient(at 0% 0%, #312e81 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, #1e1b4b 0px, transparent 50%), 
                              radial-gradient(at 50% 50%, #4338ca 0px, transparent 50%),
                              linear-gradient(to bottom, #020617, #1e1b4b);
        }

        /* Hot: Magma, Orange, Deep Red */
        .theme-hot { 
            background-image: radial-gradient(at 0% 0%, #f59e0b 0px, transparent 50%), 
                              radial-gradient(at 100% 0%, #ef4444 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, #991b1b 0px, transparent 50%),
                              linear-gradient(to bottom, #450a0a, #7f1d1d);
        }

        /* Night: Obsidian, Deep Purple, Starry Black */
        .theme-night { 
            background-image: radial-gradient(at 50% 0%, #1e1b4b 0px, transparent 50%), 
                              radial-gradient(at 0% 100%, #0f172a 0px, transparent 50%),
                              linear-gradient(to bottom, #000000, #0f172a);
        }

        /* --- HIGH-FIDELITY GLASS (Obsidian Style) --- */
        /* Darker glass improves text contrast significantly */
        .glass-card {
            background: rgba(20, 20, 20, 0.3); /* Dark tint */
            backdrop-filter: blur(40px) saturate(140%);
            -webkit-backdrop-filter: blur(40px) saturate(140%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .glass-card:active { transform: scale(0.98); }

        /* The list items need extra contrast */
        .list-item-glass {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .list-item-glass:last-child { border-bottom: none; }

        /* Noise Texture */
        .noise {
            position: absolute; inset: 0; pointer-events: none; z-index: 1; opacity: 0.04;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIi8+PC9zdmc+');
        }

        .text-glow { text-shadow: 0 0 15px rgba(255,255,255,0.4); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .safe-pt { padding-top: env(safe-area-inset-top, 24px); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 24px); }
    </style>
</head>
<body class="relative h-screen w-screen flex items-center justify-center bg-mesh-base animate-mesh theme-clear" id="app-body">

    <div class="noise"></div>
    <canvas id="weather-canvas" class="absolute inset-0 z-0 opacity-60 pointer-events-none"></canvas>

    <!-- MAIN CONTAINER -->
    <div class="relative w-full h-[100dvh] md:max-w-[420px] md:h-[92vh] md:rounded-[48px] md:border md:border-white/10 overflow-hidden flex flex-col z-10 shadow-2xl bg-black/20 backdrop-blur-sm transition-all duration-300">
        
        <!-- HEADER -->
        <header class="flex-none px-6 pt-6 safe-pt pb-2 flex justify-between items-center z-20">
            <div class="flex flex-col cursor-pointer group" onclick="toggleSearch()">
                <div class="flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-5 h-5 text-white drop-shadow-md"></i>
                    <h1 id="city-name" class="text-2xl font-bold tracking-tight text-white drop-shadow-md truncate max-w-[220px]">Locating...</h1>
                </div>
                <p id="current-date" class="text-xs font-semibold text-white/80 pl-7 tracking-widest uppercase opacity-80">Syncing...</p>
            </div>
            <button onclick="toggleSearch()" class="w-12 h-12 rounded-full glass-card flex items-center justify-center text-white hover:bg-white/10 transition-colors border border-white/20 shadow-lg">
                <i data-lucide="search" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- SEARCH OVERLAY -->
        <div id="search-overlay" class="absolute inset-0 bg-black/90 backdrop-blur-3xl z-50 translate-y-full transition-transform duration-500 cubic-bezier(0.19, 1, 0.22, 1) flex flex-col p-6">
            <div class="flex justify-end mb-10 safe-pt">
                <button onclick="toggleSearch()" class="p-3 rounded-full bg-white/10 hover:bg-white/20 transition-colors border border-white/10">
                    <i data-lucide="x" class="w-6 h-6 text-white"></i>
                </button>
            </div>
            <h2 class="text-4xl font-bold mb-8 text-white">Find City</h2>
            <form onsubmit="handleSearch(event)" class="relative w-full">
                <input type="text" id="search-input" placeholder="Search location..." class="w-full bg-white/10 border border-white/20 rounded-2xl px-6 py-5 text-xl text-white placeholder-white/40 focus:border-white/50 focus:bg-white/15 transition-all shadow-xl outline-none font-medium">
                <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-500 p-3 rounded-xl text-white shadow-lg transition-colors">
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </form>
            <div class="mt-12">
                <p class="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mb-4 pl-1">Quick Select</p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="quickSearch('London')" class="px-6 py-3 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 text-sm font-medium transition-colors text-white">London</button>
                    <button onclick="quickSearch('New York')" class="px-6 py-3 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 text-sm font-medium transition-colors text-white">New York</button>
                    <button onclick="quickSearch('Tokyo')" class="px-6 py-3 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 text-sm font-medium transition-colors text-white">Tokyo</button>
                </div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden hide-scrollbar pb-10 safe-pb px-5 relative space-y-6">
            
            <!-- HERO -->
            <section class="flex flex-col items-center justify-center pt-8 pb-4 animate-slide-up" style="animation-delay: 0.1s;">
                <div class="relative w-64 h-64 flex items-center justify-center">
                    <div class="absolute inset-0 bg-white/10 rounded-full blur-[80px] opacity-40 animate-pulse pointer-events-none"></div>
                    <img id="weather-icon" src="" alt="Condition" class="w-56 h-56 object-contain drop-shadow-2xl animate-float relative z-10 filter drop-shadow-[0_20px_50px_rgba(0,0,0,0.5)] transform scale-110">
                </div>
                
                <div class="flex flex-col items-center -mt-8 relative z-20">
                    <h1 class="text-[8rem] font-bold leading-none tracking-tighter text-white drop-shadow-2xl text-glow" id="temp-display">--</h1>
                    <div id="condition-display" class="text-base font-bold text-white uppercase tracking-[0.2em] mt-2 px-6 py-2 rounded-full glass-card bg-white/5 border border-white/20 shadow-xl backdrop-blur-md">
                        Loading...
                    </div>
                </div>
            </section>

            <!-- SHAMAN'S WISDOM (AI) -->
            <section class="glass-card rounded-[32px] p-6 animate-slide-up relative overflow-hidden group" style="animation-delay: 0.2s;">
                <!-- Decorative Glow -->
                <div class="absolute -left-10 -top-10 w-40 h-40 bg-indigo-500/20 rounded-full blur-3xl group-hover:bg-indigo-500/30 transition-all duration-1000"></div>
                
                <div class="flex items-start gap-5 relative z-10">
                    <div class="flex-shrink-0 w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center border border-white/20 shadow-inner">
                        <i data-lucide="sparkles" class="w-6 h-6 text-yellow-100"></i>
                    </div>
                    <div class="flex-1 pt-1">
                        <h3 class="text-[11px] font-bold text-indigo-200 uppercase tracking-[0.2em] mb-2 opacity-90">The Oracle</h3>
                        <p id="ai-text" class="text-[15px] leading-relaxed text-white font-medium drop-shadow-sm">Communing with the sky...</p>
                    </div>
                </div>
            </section>

            <!-- HOURLY GRAPH -->
            <section class="glass-card rounded-[32px] p-6 animate-slide-up" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-[11px] font-bold text-white/70 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="clock" class="w-3 h-3 text-blue-300"></i> 24-Hour Sight
                    </h3>
                </div>
                
                <div class="h-[90px] w-full relative mb-6">
                    <svg id="temp-graph" class="w-full h-full overflow-visible" preserveAspectRatio="none"></svg>
                </div>

                <div id="hourly-scroll" class="flex gap-6 overflow-x-auto hide-scrollbar pb-2 px-1 snap-x">
                    <!-- JS Injected -->
                </div>
            </section>

            <!-- BENTO STATS -->
            <section class="grid grid-cols-2 gap-4 animate-slide-up" style="animation-delay: 0.4s;">
                <!-- UV -->
                <div class="glass-card rounded-[32px] p-6 flex flex-col justify-between aspect-[1/1] relative overflow-hidden">
                    <div class="absolute right-0 bottom-0 w-28 h-28 bg-amber-500/10 rounded-full blur-2xl pointer-events-none"></div>
                    <div class="flex items-center gap-2 text-white/70 mb-2">
                        <i data-lucide="sun" class="w-4 h-4"></i>
                        <span class="text-[10px] font-bold uppercase tracking-wider">UV Index</span>
                    </div>
                    <div class="relative z-10">
                        <span id="uv-val" class="text-4xl font-bold tracking-tight text-white drop-shadow-md">--</span>
                        <p id="uv-text" class="text-xs text-white/80 mt-1 font-semibold tracking-wide">--</p>
                    </div>
                    <div class="w-full h-1.5 bg-white/10 rounded-full mt-4 overflow-hidden">
                        <div id="uv-bar" class="h-full bg-gradient-to-r from-yellow-200 to-amber-500 w-0 transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(251,191,36,0.5)]"></div>
                    </div>
                </div>

                <!-- Humidity -->
                <div class="glass-card rounded-[32px] p-6 flex flex-col justify-between aspect-[1/1] relative overflow-hidden">
                    <div class="absolute right-0 bottom-0 w-28 h-28 bg-cyan-500/10 rounded-full blur-2xl pointer-events-none"></div>
                    <div class="flex items-center gap-2 text-white/70 mb-2">
                        <i data-lucide="droplets" class="w-4 h-4"></i>
                        <span class="text-[10px] font-bold uppercase tracking-wider">Humidity</span>
                    </div>
                    <div class="relative z-10">
                        <span id="humidity-val" class="text-4xl font-bold tracking-tight text-white drop-shadow-md">--%</span>
                        <p id="dew-point" class="text-xs text-white/80 mt-1 font-semibold tracking-wide">Dew Pt: --°</p>
                    </div>
                     <div class="w-full h-1.5 bg-white/10 rounded-full mt-4 overflow-hidden">
                        <div id="humidity-bar" class="h-full bg-gradient-to-r from-cyan-200 to-blue-500 w-0 transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(34,211,238,0.5)]"></div>
                    </div>
                </div>

                <!-- Sun Path -->
                <div class="glass-card rounded-[32px] p-6 flex flex-col justify-between col-span-2 relative overflow-hidden">
                    <div class="flex items-center gap-2 text-white/70 mb-6">
                        <i data-lucide="horizon" class="w-4 h-4"></i>
                        <span class="text-[10px] font-bold uppercase tracking-wider">Sun Arc</span>
                    </div>
                    
                    <div class="relative h-20 w-full flex items-end mb-2">
                         <svg class="absolute bottom-0 left-0 w-full h-full" viewBox="0 0 200 80" preserveAspectRatio="none">
                            <path d="M10,80 Q100,10 190,80" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="1.5" stroke-dasharray="4 4" />
                            <circle id="sun-position" cx="10" cy="80" r="7" fill="#fff" class="shadow-[0_0_25px_#fff]" />
                         </svg>
                         
                         <div class="flex justify-between w-full relative z-10 pb-[-5px]">
                             <div class="flex flex-col transform translate-y-6">
                                <span class="text-[10px] text-white/50 uppercase font-bold">Rise</span>
                                <span id="sunrise-val" class="text-base font-bold text-white">--:--</span>
                             </div>
                             <div class="flex flex-col items-end transform translate-y-6">
                                <span class="text-[10px] text-white/50 uppercase font-bold">Set</span>
                                <span id="sunset-val" class="text-base font-bold text-white">--:--</span>
                             </div>
                         </div>
                    </div>
                </div>
            </section>

            <!-- 7-DAY FORECAST (HIGH LEGIBILITY) -->
            <section class="glass-card rounded-[32px] p-6 animate-slide-up mb-8" style="animation-delay: 0.5s;">
                 <h3 class="text-[11px] font-bold text-white/70 mb-6 flex items-center gap-2 uppercase tracking-widest">
                    <i data-lucide="calendar-days" class="w-3 h-3"></i> The Week Ahead
                </h3>
                <div id="daily-container" class="space-y-1">
                    <!-- Rows injected here -->
                </div>
            </section>

            <footer class="text-center text-[10px] text-white/30 pb-4 uppercase tracking-[0.3em] font-bold">
                Shaman Ultima OS
            </footer>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // CONFIG
        const state = {
            lat: -25.7449, lon: 28.1879, city: "Pretoria", units: "metric",
            weatherData: null
        };

        const els = {
            body: document.getElementById('app-body'),
            city: document.getElementById('city-name'),
            date: document.getElementById('current-date'),
            temp: document.getElementById('temp-display'),
            condition: document.getElementById('condition-display'),
            icon: document.getElementById('weather-icon'),
            aiText: document.getElementById('ai-text'),
            hourlyScroll: document.getElementById('hourly-scroll'),
            graph: document.getElementById('temp-graph'),
            dailyContainer: document.getElementById('daily-container'),
            uvVal: document.getElementById('uv-val'),
            uvText: document.getElementById('uv-text'),
            uvBar: document.getElementById('uv-bar'),
            humidity: document.getElementById('humidity-val'),
            humidityBar: document.getElementById('humidity-bar'),
            dewPoint: document.getElementById('dew-point'),
            sunrise: document.getElementById('sunrise-val'),
            sunset: document.getElementById('sunset-val'),
            searchOverlay: document.getElementById('search-overlay'),
            searchInput: document.getElementById('search-input'),
            sunPos: document.getElementById('sun-position')
        };

        // --- PARTICLE CANVAS ---
        const canvas = document.getElementById('weather-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationId;
        
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(type) { this.type = type; this.reset(); }
            reset() {
                // Logic runs in logical pixels, not scaled
                const w = canvas.width / (window.devicePixelRatio || 1);
                const h = canvas.height / (window.devicePixelRatio || 1);
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.alpha = Math.random() * 0.5 + 0.2;
                this.size = Math.random() * 2;
                
                if (this.type === 'rain') {
                    this.y = Math.random() * h - h;
                    this.vy = Math.random() * 15 + 10;
                    this.vx = (Math.random() - 0.5) * 1;
                    this.len = Math.random() * 25 + 10;
                } else if (this.type === 'snow') {
                    this.y = Math.random() * h - h;
                    this.vy = Math.random() * 2 + 1;
                    this.vx = (Math.random() - 0.5) * 1;
                    this.size = Math.random() * 3 + 2;
                } else {
                    // Floating dust
                    this.vx = (Math.random() - 0.5) * 0.2;
                    this.vy = (Math.random() - 0.5) * 0.2;
                }
            }
            update() {
                const w = canvas.width / (window.devicePixelRatio || 1);
                const h = canvas.height / (window.devicePixelRatio || 1);
                
                this.x += this.vx; this.y += this.vy;
                if (this.type === 'rain' || this.type === 'snow') {
                    if (this.y > h) this.reset();
                } else {
                    if (this.x < 0) this.x = w;
                    if (this.x > w) this.x = 0;
                    if (this.y < 0) this.y = h;
                    if (this.y > h) this.y = 0;
                }
            }
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                ctx.strokeStyle = `rgba(255, 255, 255, ${this.alpha * 0.6})`;
                if (this.type === 'rain') {
                    ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.vx, this.y + this.len); ctx.lineWidth = 1; ctx.stroke();
                } else {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
            }
        }

        function initParticles(type) {
            particles = [];
            const count = type === 'rain' ? 200 : type === 'snow' ? 100 : 50;
            for(let i=0; i<count; i++) particles.push(new Particle(type));
        }

        function animate() {
            if (document.hidden) {
                // Pause animation loop if tab is hidden
                return;
            }
            const dpr = window.devicePixelRatio || 1;
            // Clear using the scaled dimensions logic
            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
            particles.forEach(p => { p.update(); p.draw(); });
            animationId = requestAnimationFrame(animate);
        }
        
        // Handle Visibility Change to pause/resume animation
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                cancelAnimationFrame(animationId);
                animate();
            }
        });
        
        animate();

        // --- WEATHER LOGIC ---
        const wmoCodes = {
            0: { desc: "Clear", icon: "sun", type: "clear", theme: "theme-clear" },
            1: { desc: "Fair", icon: "sun-dim", type: "clear", theme: "theme-clear" },
            2: { desc: "Cloudy", icon: "cloud-sun", type: "cloud", theme: "theme-cloudy" },
            3: { desc: "Overcast", icon: "cloud", type: "cloud", theme: "theme-cloudy" },
            45: { desc: "Fog", icon: "cloud-fog", type: "cloud", theme: "theme-cloudy" },
            51: { desc: "Drizzle", icon: "cloud-drizzle", type: "rain", theme: "theme-rain" },
            61: { desc: "Rain", icon: "cloud-rain", type: "rain", theme: "theme-rain" },
            63: { desc: "Heavy Rain", icon: "cloud-rain", type: "rain", theme: "theme-rain" },
            71: { desc: "Snow", icon: "snowflake", type: "snow", theme: "theme-cloudy" },
            95: { desc: "Storm", icon: "zap", type: "rain", theme: "theme-night" }
        };

        function getWmoInfo(code) { return wmoCodes[code] || wmoCodes[0]; }

        function generateAI(current, desc, isNight) {
            const t = current.temperature_2m;
            if (t > 30) return "The heat spirits are dancing. Seek shade.";
            if (t < 5) return "The frost breath is upon us. Bundle up.";
            if (desc.includes("Rain")) return "The sky is cleansing the earth.";
            if (desc.includes("Storm")) return "Nature roars. Respect the thunder.";
            if (isNight) return "The cosmos watches over you.";
            return `A balance of elements. ${desc}, ${Math.round(t)}°.`;
        }

        async function fetchWeather() {
            els.condition.innerText = "Divining...";
            try {
                const params = new URLSearchParams({
                    latitude: state.lat, longitude: state.lon,
                    current: "temperature_2m,relative_humidity_2m,is_day,weather_code,wind_speed_10m,pressure_msl",
                    hourly: "temperature_2m,weather_code",
                    daily: "weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max",
                    timezone: "auto"
                });
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?${params}`);
                if(!res.ok) throw new Error();
                updateUI(await res.json());
            } catch { els.condition.innerText = "Silence"; }
        }

        function updateUI(data) {
            const current = data.current;
            const daily = data.daily;
            const wmo = getWmoInfo(current.weather_code);
            
            // Theme
            let theme = wmo.theme;
            if(current.is_day === 0) theme = "theme-night";
            if(current.temperature_2m > 30) theme = "theme-hot";
            els.body.className = `relative h-screen w-screen flex items-center justify-center bg-mesh-base animate-mesh ${theme}`;
            
            // Particles
            initParticles(wmo.type);

            // Text Data
            els.city.innerText = state.city;
            els.date.innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            els.temp.innerText = Math.round(current.temperature_2m) + "°";
            els.condition.innerText = wmo.desc;
            
            // Icon
            const iconMap = {
                'clear': 'https://cdn-icons-png.flaticon.com/512/3222/3222800.png',
                'cloud': 'https://cdn-icons-png.flaticon.com/512/1146/1146869.png',
                'rain': 'https://cdn-icons-png.flaticon.com/512/3351/3351979.png',
                'snow': 'https://cdn-icons-png.flaticon.com/512/642/642000.png',
                'night': 'https://cdn-icons-png.flaticon.com/512/3222/3222797.png'
            };
            let iUrl = iconMap[wmo.type];
            if(current.is_day === 0 && wmo.type === 'clear') iUrl = iconMap['night'];
            els.icon.src = iUrl;

            // AI
            els.aiText.innerText = generateAI(current, wmo.desc, current.is_day === 0);

            // Graphs
            renderHourly(data.hourly, current.time);
            renderDaily(daily);

            // Stats
            const uv = daily.uv_index_max[0];
            els.uvVal.innerText = uv;
            els.uvText.innerText = uv < 3 ? "Safe" : uv < 6 ? "Mod" : "High";
            els.uvBar.style.width = Math.min((uv/10)*100, 100) + "%";
            
            els.humidity.innerText = current.relative_humidity_2m + "%";
            els.dewPoint.innerText = `Dew: ${Math.round(current.temperature_2m - ((100-current.relative_humidity_2m)/5))}°`;
            
            els.sunrise.innerText = new Date(daily.sunrise[0]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            els.sunset.innerText = new Date(daily.sunset[0]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            updateSun(daily.sunrise[0], daily.sunset[0]);

            if(window.lucide) lucide.createIcons();
        }

        // --- RENDER FUNCTIONS ---
        function renderHourly(hourly, nowStr) {
            // SAFE INDEX CALCULATION
            let idx = hourly.time.findIndex(t => t >= nowStr);
            if (idx === -1) idx = 0; // Fallback if time not found or end of list

            const temps = hourly.temperature_2m.slice(idx, idx+24);
            const codes = hourly.weather_code.slice(idx, idx+24);
            
            // Scroll
            let html = "";
            temps.forEach((t, i) => {
                const h = new Date(hourly.time[idx+i]).getHours();
                const icon = getWmoInfo(codes[i]).icon;
                html += `
                    <div class="flex flex-col items-center gap-3 min-w-[60px] snap-center">
                        <span class="text-[11px] font-bold text-white/60">${h}:00</span>
                        <div class="p-2.5 rounded-full bg-white/10 border border-white/10 shadow-sm">
                            <i data-lucide="${icon}" class="w-5 h-5 text-white"></i>
                        </div>
                        <span class="text-lg font-bold text-white">${Math.round(t)}°</span>
                    </div>`;
            });
            els.hourlyScroll.innerHTML = html;

            // Graph (Simple Smooth)
            if(temps.length > 1) {
                const min = Math.min(...temps)-2;
                const max = Math.max(...temps)+2;
                const rng = max - min;
                const w = 1000, h = 100;
                const step = w / (temps.length-1);
                
                const pt = i => ({x: i*step, y: h - ((temps[i]-min)/rng)*h});
                let d = `M ${pt(0).x} ${pt(0).y}`;
                for(let i=0; i<temps.length-1; i++) {
                    const p0=pt(i>0?i-1:i), p1=pt(i), p2=pt(i+1), p3=pt(i+2<temps.length?i+2:i+1);
                    const cp1x = p1.x + (p2.x-p0.x)/6;
                    const cp1y = p1.y + (p2.y-p0.y)/6;
                    const cp2x = p2.x - (p3.x-p1.x)/6;
                    const cp2y = p2.y - (p3.y-p1.y)/6;
                    d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
                const fill = `${d} L ${w} ${h} L 0 ${h} Z`;
                
                // Add viewBox for proper scaling
                els.graph.setAttribute("viewBox", "0 0 1000 100");
                els.graph.innerHTML = `
                    <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.3)"/><stop offset="100%" stop-color="transparent"/></linearGradient></defs>
                    <path d="${fill}" fill="url(#g)" />
                    <path d="${d}" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="3" stroke-linecap="round"/>
                `;
            }

            // Re-render icons for new content
            if(window.lucide) lucide.createIcons();
        }

        function renderDaily(daily) {
            let html = "";
            for(let i=1; i<7; i++) {
                const date = new Date(daily.time[i]);
                const day = date.toLocaleDateString('en-US', {weekday:'long'});
                const min = Math.round(daily.temperature_2m_min[i]);
                const max = Math.round(daily.temperature_2m_max[i]);
                const info = getWmoInfo(daily.weather_code[i]);
                
                // RANGE BAR CALC
                const range = 40; // -5 to 35
                const left = ((min + 5) / range) * 100;
                const width = ((max - min) / range) * 100;

                html += `
                    <div class="grid grid-cols-[100px_1fr_100px] items-center py-4 border-b border-white/10 list-item-glass px-4 rounded-xl mb-1 last:mb-0">
                        <span class="text-[15px] font-bold text-white tracking-wide">${day}</span>
                        
                        <div class="flex items-center gap-3">
                            <i data-lucide="${info.icon}" class="w-5 h-5 text-white/90"></i>
                            <span class="text-xs font-medium text-white/80 opacity-90 truncate">${info.desc}</span>
                        </div>
                        
                        <div class="flex items-center justify-end gap-3 w-full">
                            <span class="text-sm font-semibold text-white/70 w-8 text-right">${min}°</span>
                            <div class="w-16 h-1.5 bg-white/10 rounded-full relative overflow-hidden hidden sm:block">
                                <div class="absolute h-full rounded-full bg-gradient-to-r from-blue-300 to-yellow-300" style="left:${left}%; width:${width}%"></div>
                            </div>
                            <span class="text-sm font-bold text-white w-8 text-right">${max}°</span>
                        </div>
                    </div>
                `;
            }
            els.dailyContainer.innerHTML = html;

            // Re-render icons for new content
            if(window.lucide) lucide.createIcons();
        }

        function updateSun(riseStr, setStr) {
            const now = Date.now(), rise = new Date(riseStr).getTime(), set = new Date(setStr).getTime();
            let pct = now > rise && now < set ? (now-rise)/(set-rise) : (now>=set ? 1 : 0);
            const x = 10 + (pct * 180);
            const y = 80 - (Math.sin(pct * Math.PI) * 70);
            els.sunPos.setAttribute('cx', x);
            els.sunPos.setAttribute('cy', y);
        }

        function toggleSearch() {
            els.searchOverlay.classList.toggle('translate-y-full');
            if(!els.searchOverlay.classList.contains('translate-y-full')) setTimeout(()=>els.searchInput.focus(), 300);
        }

        async function handleSearch(e) {
            e.preventDefault();
            const q = els.searchInput.value;
            if(!q) return;
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=en&format=json`);
                const d = await res.json();
                if(d.results) {
                    state.lat = d.results[0].latitude; state.lon = d.results[0].longitude; state.city = d.results[0].name;
                    toggleSearch(); els.searchInput.value=""; fetchWeather();
                } else alert("Unknown location");
            } catch { alert("Connection Error"); }
        }

        function quickSearch(c) { els.searchInput.value = c; handleSearch({preventDefault:()=>{}}); }

        if(window.lucide) lucide.createIcons();
        fetchWeather();
    </script>
</body>
</html>
